<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout</title>
    <link rel="shortcut icon" th:href="@{/images/favicon.ico}" type="image/x-icon">
    <link rel="stylesheet" th:href="@{/css/frontoffice.css}">
    <script th:src="@{/js/buscarCep.js}"></script>
    <!--Carlita favor passar para o css-->
    <style>
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgb(0,0,0);
            background-color: rgba(0,0,0,0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
    <script>
        function toggleCartaoCampos() {
            var formaPagamento = document.getElementById("formaPagamento").value;
            var cartaoCampos = document.getElementById("cartaoCampos");
            var parcelasDiv = document.getElementById("parcelasDiv");
            var parcelasSelect = document.getElementById("parcelas");

            var numeroCartao = document.getElementById("numeroCartao");
            var codigoVerificador = document.getElementById("codigoVerificador");
            var nomeCompleto = document.getElementById("nomeCompleto");
            var dataVencimento = document.getElementById("dataVencimento");

            if (formaPagamento === "CREDITO" || formaPagamento === "DEBITO") {
                cartaoCampos.style.display = "block";
            } else {
                cartaoCampos.style.display = "none";
                numeroCartao.value = "";
                codigoVerificador.value = "";
                nomeCompleto.value = "";
                dataVencimento.value = "";
            }

            if (formaPagamento === "CREDITO") {
                parcelasDiv.style.display = "block";
            } else {
                parcelasDiv.style.display = "none";
                parcelasSelect.value = "";
            }
        }

        function formatarNumeroCartao() {
            var input = document.getElementById("numeroCartao");
            var numeroCartao = input.value.replace(/\D/g, '');
            numeroCartao = numeroCartao.match(/.{1,4}/g);
            if (numeroCartao) {
                input.value = numeroCartao.join(' ');
            }
        }

        function validarCamposCartao() {
            var formaPagamento = document.getElementById("formaPagamento").value;
            if (formaPagamento === "CREDITO" || formaPagamento === "DEBITO") {
                var numeroCartao = document.getElementById("numeroCartao").value.trim();
                var codigoVerificador = document.getElementById("codigoVerificador").value.trim();
                var nomeCompleto = document.getElementById("nomeCompleto").value.trim();
                var dataVencimento = document.getElementById("dataVencimento").value.trim();

                if (numeroCartao === "" || codigoVerificador === "" || nomeCompleto === "" || dataVencimento === "") {
                    alert("Preencha todos os campos do cartão de crédito.");
                    return false;
                }
            }
            return true;
        }

        function mostrarEtapa(ocultar, mostrar) {
            document.getElementById(ocultar).style.display = "none";
            document.getElementById(mostrar).style.display = "block";

            if (ocultar === 'etapa-endereco') {
                document.getElementById('hidden-endereco').value = document.getElementById('endereco-entrega').value;
            }

            if (ocultar === 'etapa-pagamento') {
                var formaPagamentoSelecionada = document.getElementById('formaPagamento').value;
                document.getElementById('formaPagamento-text').innerText = formaPagamentoSelecionada;
                document.getElementById('hidden-forma-pagamento').value = formaPagamentoSelecionada;
            }


        }

        function proximaEtapa(atual, proxima) {
            if (atual === 'etapa-pagamento') {
                if (!validarCamposCartao()) {
                    return;
                }
            }
            mostrarEtapa(atual, proxima);
        }

        window.onload = function () {
            toggleCartaoCampos();
            var etapaAtual = /*[[${etapaAtual}]]*/ 'null';
            if (etapaAtual !== 'null') {
                mostrarEtapa('etapa-endereco', etapaAtual);
            }
        };


        function abrirModal() {
            document.getElementById("modal").style.display = "block";
        }

        function fecharModal() {
            document.getElementById("modal").style.display = "none";
        }

        window.onclick = function(event) {
            if (event.target == document.getElementById("modal")) {
                fecharModal();
            }
        }

        function validarFormulario(event) {
            const cepInput = document.getElementById("cep").value;
            const logradouroInput = document.getElementById("logradouro").value;
            const numeroInput = document.getElementById("numero").value;
            const bairroInput = document.getElementById("bairro").value;
            const cidadeInput = document.getElementById("cidade").value;
            const estadoInput = document.getElementById("estado").value;

            if (!cepInput || !logradouroInput || !numeroInput || !bairroInput || !cidadeInput || !estadoInput) {
                event.preventDefault();
                alert("Por favor, preencha todos os campos obrigatórios.");
                return false;
            }

            return true;
        }
    </script>
</head>
<body>
<header>
    <div th:replace="fragments/header :: header"></div>
    <button class="btn-voltar" onclick="window.location.href='/'" type="button"><img th:src="@{/images/seta.png}">
    </button>
</header>

<main>
    <section class="checkout-container">
        <div class="left-group">
            <!-- Seção de Endereço -->
            <div id="etapa-endereco">
                <div class="endereco-checkout">
                    <label for="endereco-faturamento">Endereço de faturamento:</label>
                    <div class="select-field" id="endereco-faturamento" th:text="${enderecoFaturamento.logradouro + ', ' + enderecoFaturamento.numero + ' - ' + enderecoFaturamento.bairro}"></div>
                </div>
                <div class="endereco-checkout">
                    <label for="endereco-entrega">Endereço de entrega:</label>
                    <select class="select-field" id="endereco-entrega" required th:field="*{enderecoEntrega}">
                        <!-- TODO: Endereço padrão não está sendo automaticamente escolhido pelo dropdown, necessário verificar-->
                        <option th:each="enderecos : ${enderecoEntrega}"
                                th:selected="${enderecos.id == enderecoPadrao.id}"
                                th:text="${enderecos.logradouro + ', ' + enderecos.numero + ' - ' + enderecos.bairro}"
                                th:value="${enderecos.id}">
                        </option>
                    </select>
                </div>
                <div>
                    <!-- Modal de Cadastro de Endereço -->
                    <button id="button-modal-endereco" onclick="abrirModal()">Cadastrar Endereço</button>
                    <div id="modal" class="modal">
                        <div class="modal-content">
                            <span class="close" onclick="fecharModal()">&times;</span>
                            <form method="post" id="form-endereco-modal" onsubmit="return validarFormulario(event);"
                                  th:action="@{/endereco/cadastrar}" th:object="${endereco}">
                                <div class="input-group">
                                    <label for="cep">CEP:</label>
                                    <div class="campo-cep">
                                        <input id="cep" required th:field="*{cep}" type="text" maxlength="8" oninput="buscarCep(this.value)"/>
                                        <div th:errors="*{cep}" th:if="${#fields.hasErrors('cep')}"></div>
                                    </div>
                                </div>

                                <div class="input-group">
                                    <label for="logradouro">Logradouro:</label>
                                    <input id="logradouro" required th:field="*{logradouro}" type="text" readonly/>
                                    <div th:errors="*{logradouro}" th:if="${#fields.hasErrors('logradouro')}"></div>
                                </div>

                                <div class="input-group">
                                    <label for="numero">Número:</label>
                                    <input id="numero" required th:field="*{numero}" type="text"/>
                                    <div th:errors="*{numero}" th:if="${#fields.hasErrors('numero')}"></div>
                                </div>

                                <div class="input-group">
                                    <label for="complemento">Complemento</label>
                                    <input id="complemento" th:field="*{complemento}" type="text">
                                    <div th:erros="*{complemento}" th:if="${#fields.hasErrors('complemento')}"></div>
                                </div>

                                <div class="input-group">
                                    <label for="bairro">Bairro:</label>
                                    <input id="bairro" required th:field="*{bairro}" type="text" readonly/>
                                    <div th:errors="*{bairro}" th:if="${#fields.hasErrors('bairro')}"></div>
                                </div>

                                <div class="input-group">
                                    <label for="cidade">Cidade:</label>
                                    <input id="cidade" required th:field="*{cidade}" type="text" readonly>
                                    <div th:errors="*{cidade}" th:if="${#fields.hasErrors('cidade')}"></div>
                                </div>

                                <div class="input-group">
                                    <label for="estado">Estado:</label>
                                    <input id="estado" required th:field="*{estado}" type="text" readonly/>
                                    <div th:errors="*{estado}" th:if="${#fields.hasErrors('estado')}"></div>
                                </div>

                                <input type="hidden" name="redirect" value="/carrinho/checkout"/>
                                <button type="submit" class="btn-padrao">Cadastrar Endereço</button>
                            </form>
                        </div>
                    </div>
                </div>
                <button class="btn-proxima-etapa" onclick="proximaEtapa('etapa-endereco', 'etapa-pagamento')">Próxima
                    Etapa
                </button>
            </div>

            <!-- Seção de Pagamento -->
            <div id="etapa-pagamento" style="display: none;">
                <div class="pagamento-checkout">
                    <label for="formaPagamento">Forma de Pagamento:</label>
                    <select class="select-field" id="formaPagamento" onchange="toggleCartaoCampos()" required>
                        <option class="option-select" value="BOLETO">Boleto Bancário</option>
                        <option class="option-select" value="CREDITO">Cartão de Crédito</option>
                        <option class="option-select" value="DEBITO">Cartão de Débito</option>
                    </select>
                </div>

                <div id="cartaoCampos" style="display: none;">
                    <div>
                        <label for="numeroCartao">Número do Cartão:</label>
                        <input id="numeroCartao" maxlength="19" oninput="formatarNumeroCartao()"
                               placeholder="0000 0000 0000 0000" required type="text">
                    </div>
                    <div>
                        <label for="codigoVerificador">Código Verificador (CVV):</label>
                        <input id="codigoVerificador" maxlength="3" pattern="\d{3}" placeholder="123" required
                               type="text">
                    </div>
                    <div>
                        <label for="nomeCompleto">Nome Completo:</label>
                        <input id="nomeCompleto" maxlength="40" placeholder="Nome Completo" required type="text">
                    </div>
                    <div>
                        <label for="dataVencimento">Data de Vencimento:</label>
                        <input id="dataVencimento" required type="month">
                    </div>
                    <div id="parcelasDiv" style="display: none;">
                        <label for="parcelas">Quantidade de Parcelas:</label>
                        <select id="parcelas">
                            <option value="1">1x</option>
                            <option value="2">2x</option>
                            <option value="3">3x</option>
                            <option value="4">4x</option>
                            <option value="5">5x</option>
                            <option value="6">6x</option>
                            <option value="7">7x</option>
                            <option value="8">8x</option>
                            <option value="9">9x</option>
                            <option value="10">10x</option>
                        </select>
                    </div>
                </div>
                <button class="btn-voltar-etapa" onclick="mostrarEtapa('etapa-pagamento', 'etapa-endereco')">Voltar
                </button>
                <button class="btn-proxima-etapa" onclick="proximaEtapa('etapa-pagamento', 'etapa-resumo')">Próxima
                    Etapa
                </button>
            </div>

            <!-- Seção de Resumo dos Itens -->
            <div id="etapa-resumo" style="display: none;">
                <p>Resumo do Pedido</p>
                <div class="card-row">
                    <div id="itens-resumo" th:each=" item : ${carrinho.itens}">
                        <div class="desc-produto-row">
                            <div th:each="imagem : ${item.produto.imagens}">
                                <img alt="Imagem do Produto - ${item.produto.nome}" class="imagem-produto-carrinho"
                                     th:src="@{/imagem/{id}(id=${imagem.id})}"/>
                            </div>

                            <div class="produto-carrinho">
                                <p class="info-produto"><strong>Produto:</strong></p>
                                <span th:text="${item.produto.nome}"></span>
                            </div>

                            <div class="quantidade-carrinho">
                                <p class="info-produto"><strong>Quantidade:</strong></p>
                                <span th:text="${item.quantidade}"></span>
                            </div>

                            <div class="preco-carrinho">
                                <p class="info-produto"><strong>Preço:</strong></p>
                                <span th:text="'R$ ' + ${#numbers.formatDecimal(item.valorItem, 1, 2)}"></span>
                            </div>
                        </div>
                    </div>

                    <p id="itens-text" style="display: none" th:text="${carrinho.itens}"></p>

                    <div id="valor-subtotal-resumo">
                        <p>Subtotal: </p>
                        <span id="valor-subtotal-text"
                              th:text="'R$ ' + ${#numbers.formatDecimal(carrinho.valorTotal, 1, 2)}"></span>
                    </div>
                    <div id="valor-frete-resumo">
                        <p>Frete: </p>
                        <span id="valor-frete-text"
                              th:text="'R$ ' + ${#numbers.formatDecimal(carrinho.frete, 1, 2)}"></span>
                    </div>
                    <div id="valor-total-resumo">
                        <p>Valor Total: </p>
                        <span id="valor-total-text"
                              th:text="'R$ ' + ${#numbers.formatDecimal(carrinho.valorComFrete, 1, 2)}"></span>
                    </div>
                    <div id="formaPagamento-resumo">
                        <p>Forma de Pagamento: </p>
                        <span id="formaPagamento-text"></span>
                    </div>
                </div>

                <div id="finalizar-pedido">
                    <form method="post" th:action="@{/pedido/finalizar}">
                        <input id="hidden-endereco" name="endereco" type="hidden">
                        <input id="hidden-forma-pagamento" name="forma-pagamento" type="hidden">

                        <button class="btn-voltar-etapa" onclick="mostrarEtapa('etapa-revisao', 'etapa-pagamento')">Voltar</button>
                        <button type="submit" class="btn-finalizar-compra">Finalizar Compra</button>
                    </form>
                </div>
            </div>
        </div>
    </section>
</main>
</body>
</html>
